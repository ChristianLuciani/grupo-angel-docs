# üìö CLib API Reference

> Documentaci√≥n completa de todas las funciones de CLib v6.0.0

---

## üìã √çndice R√°pido

### üîê [Auth Module](#auth-module)
- [getUserDetails()](#getuserdetails)
- [getUserRole()](#getuserrole)
- [setImpersonatedRole()](#setimpersonatedrole)
- [clearImpersonatedRole()](#clearimpersonatedrole)
- [getLogoutUrl()](#getlogouturl)

### üõ†Ô∏è [Services Module](#services-module)
- [logDebugMessage()](#logdebugmessage)
- [getOrCreateMonthlyFolder()](#getorcreateMonthlyfolder)
- [callGenerativeApi()](#callgenerativeapi)
- [insertRowIntoBigQuery()](#insertrowtobigquery)

### üîÑ [ETL Module](#etl-module)
- [detectFileType()](#detectfiletype)
- [transformAxesGamingVoucher()](#transformaxesgamingvoucher)
- [transformAxesTITOBreakdown()](#transformaxestitobreakdown)
- [transformSielconTITO()](#transformsielcontito)
- [transformSielconByPlayer()](#transformsielconbyplayer)

### üì¶ [Legacy Module](#legacy-module) ‚ö†Ô∏è
- [xls2gsheet()](#xls2gsheet) (deprecated)
- [extraerDatosDeHTML()](#extraerdatosdehtml) (deprecated)

---

## üîê Auth Module

Funciones para autenticaci√≥n y autorizaci√≥n de usuarios.

---

### `getUserDetails()`

Obtiene informaci√≥n completa del usuario autenticado.

#### Sintaxis
```javascript
CLib.getUserDetails()
Par√°metros
Ninguno.
Retorno
javascript{
  success: true,
  data: {
    email: "usuario@grupoangel.com",
    name: "Christian Luciani",
    photoUrl: "https://...",
    isAuthenticated: true
  }
}
Ejemplo de Uso
javascriptfunction checkUser() {
  const result = CLib.getUserDetails();
  
  if (!result.success) {
    return ContentService.createTextOutput('Error de autenticaci√≥n');
  }
  
  const user = result.data;
  Logger.log('Usuario: ' + user.name);
  Logger.log('Email: ' + user.email);
}
Casos de Error
javascript{
  success: false,
  error: "Usuario no autenticado"
}
Notas

‚úÖ Usa Session.getActiveUser() internamente
‚úÖ Cache la respuesta si la llamas m√∫ltiples veces
‚ö†Ô∏è Requiere que el usuario est√© logueado en Google


getUserRole()
Determina el rol del usuario basado en su email.
Sintaxis
javascriptCLib.getUserRole(email)
Par√°metros
NombreTipoRequeridoDescripci√≥nemailStringNoEmail a verificar. Si se omite, usa usuario actual
Retorno
javascript{
  success: true,
  data: {
    role: "admin",  // admin | supervisor | operator
    permissions: {
      canApprove: true,
      canDelete: true,
      canViewReports: true
    }
  }
}
Ejemplo de Uso
javascriptfunction doGet(e) {
  const roleResult = CLib.getUserRole();
  
  if (!roleResult.success) {
    return HtmlService.createHtmlOutput('AccessDenied.html');
  }
  
  const role = roleResult.data.role;
  
  // Cargar interfaz seg√∫n rol
  switch(role) {
    case 'admin':
      return HtmlService.createHtmlOutput('AdminDashboard.html');
    case 'supervisor':
      return HtmlService.createHtmlOutput('Supervisor.html');
    case 'operator':
      return HtmlService.createHtmlOutput('Operator.html');
    default:
      return HtmlService.createHtmlOutput('AccessDenied.html');
  }
}
L√≥gica de Roles
javascript// Definida en Config.gs de cada app
const ADMIN_EMAILS = ['admin@grupoangel.com'];
const SUPERVISOR_EMAILS = ['supervisor@grupoangel.com'];
// Resto = operator
Notas

‚úÖ Verifica contra listas definidas en Config.gs
‚úÖ Case-insensitive (normaliza a lowercase)
‚ö†Ô∏è Modo "impersonation" tiene prioridad (ver siguiente funci√≥n)


setImpersonatedRole()
Simula un rol diferente (solo para testing).
Sintaxis
javascriptCLib.setImpersonatedRole(role)
Par√°metros
NombreTipoRequeridoDescripci√≥nroleStringS√≠Rol a simular: 'admin', 'supervisor', 'operator'
Retorno
javascript{
  success: true,
  data: {
    impersonatedRole: "supervisor",
    originalRole: "admin"
  }
}
Ejemplo de Uso
javascript// En AdminDashboard.html
function testAsSupervisor() {
  CLib.setImpersonatedRole('supervisor');
  location.reload();  // Recarga con rol simulado
}

function stopTesting() {
  CLib.clearImpersonatedRole();
  location.reload();
}
Notas

‚ö†Ô∏è SOLO PARA TESTING - No usar en producci√≥n
‚úÖ Se guarda en PropertiesService (sesi√≥n)
‚úÖ Se limpia autom√°ticamente al cerrar sesi√≥n
üîí Solo admins pueden impersonar

Casos de Error
javascript{
  success: false,
  error: "Solo admins pueden usar impersonation"
}

clearImpersonatedRole()
Limpia el rol simulado y vuelve al rol real.
Sintaxis
javascriptCLib.clearImpersonatedRole()
Par√°metros
Ninguno.
Retorno
javascript{
  success: true,
  data: {
    clearedRole: "supervisor",
    currentRole: "admin"
  }
}
Ejemplo de Uso
javascript// Bot√≥n "Stop Impersonating" en UI
google.script.run
  .withSuccessHandler(() => location.reload())
  .withFailureHandler((error) => alert('Error: ' + error))
  .clearImpersonatedRole();

getLogoutUrl()
Genera URL de logout de Google.
Sintaxis
javascriptCLib.getLogoutUrl(redirectUrl)
Par√°metros
NombreTipoRequeridoDescripci√≥nredirectUrlStringNoURL donde redirigir despu√©s de logout
Retorno
javascript{
  success: true,
  data: {
    logoutUrl: "https://accounts.google.com/Logout?continue=..."
  }
}
Ejemplo de Uso
javascript// En main.js.html (AngelStyle)
function handleLogout() {
  google.script.run
    .withSuccessHandler((result) => {
      if (result.success) {
        window.top.location.href = result.data.logoutUrl;
      }
    })
    .getLogoutUrl(window.location.href);
}

üõ†Ô∏è Services Module
Funciones de servicios generales.

logDebugMessage()
Registra mensajes de debug con contexto.
Sintaxis
javascriptCLib.logDebugMessage(message, context)
Par√°metros
NombreTipoRequeridoDescripci√≥nmessageStringS√≠Mensaje principalcontextObjectNoInformaci√≥n adicional
Retorno
javascript{
  success: true,
  data: {
    logged: true,
    timestamp: "2025-10-09T10:30:00Z"
  }
}
Ejemplo de Uso
javascriptfunction processTicket(ticketData) {
  try {
    CLib.logDebugMessage('Iniciando proceso de ticket', {
      user: Session.getActiveUser().getEmail(),
      ticketId: ticketData.id
    });
    
    // ... l√≥gica de procesamiento
    
    CLib.logDebugMessage('Ticket procesado exitosamente', {
      ticketId: ticketData.id,
      duration: '3.2s'
    });
    
  } catch (error) {
    CLib.logDebugMessage('ERROR en processTicket', {
      error: error.toString(),
      stack: error.stack,
      ticketData: ticketData
    });
    throw error;
  }
}
Formato de Log
[2025-10-09 10:30:00] Iniciando proceso de ticket
Context: {
  "user": "christian@grupoangel.com",
  "ticketId": "TKT-12345"
}
D√≥nde se Guardan

‚úÖ Logger.log() (visible en Executions)
‚úÖ PropertiesService (√∫ltimos 100 logs)
üîÆ Futuro: BigQuery logs table


getOrCreateMonthlyFolder()
Crea o encuentra carpeta mensual en Drive.
Sintaxis
javascriptCLib.getOrCreateMonthlyFolder(parentFolderId, prefix)
Par√°metros
NombreTipoRequeridoDescripci√≥nparentFolderIdStringS√≠ID de carpeta padreprefixStringNoPrefijo para nombre (ej: 'Tickets')
Retorno
javascript{
  success: true,
  data: {
    folderId: "1ABC...XYZ",
    folderName: "2025-10-Tickets",
    wasCreated: false  // true si se cre√≥ nueva
  }
}
Ejemplo de Uso
javascriptfunction saveTicketImage(imageBlob) {
  const UPLOADS_FOLDER_ID = PropertiesService.getScriptProperties()
    .getProperty('UPLOADS_FOLDER_ID');
  
  // Obtener/crear carpeta del mes actual
  const folderResult = CLib.getOrCreateMonthlyFolder(
    UPLOADS_FOLDER_ID,
    'Tickets'
  );
  
  if (!folderResult.success) {
    throw new Error('No se pudo crear carpeta: ' + folderResult.error);
  }
  
  // Guardar imagen en carpeta
  const folder = DriveApp.getFolderById(folderResult.data.folderId);
  const file = folder.createFile(imageBlob);
  
  return file.getId();
}
Estructura Creada
Parent Folder/
‚îî‚îÄ‚îÄ 2025-10-Tickets/    ‚Üê Creada autom√°ticamente
    ‚îú‚îÄ‚îÄ ticket1.jpg
    ‚îú‚îÄ‚îÄ ticket2.jpg
    ‚îî‚îÄ‚îÄ ...
Notas

‚úÖ Si carpeta ya existe, retorna su ID
‚úÖ Formato: YYYY-MM-Prefix
‚úÖ Thread-safe (maneja concurrencia)


callGenerativeApi()
Llama a Gemini AI para an√°lisis de texto/imagen.
Sintaxis
javascriptCLib.callGenerativeApi(prompt, imageBase64, options)
Par√°metros
NombreTipoRequeridoDescripci√≥npromptStringS√≠Instrucciones para el modeloimageBase64StringNoImagen en base64 (para Vision)optionsObjectNoConfiguraci√≥n adicional
Options
javascript{
  model: 'gemini-2.5-flash',  // Default
  temperature: 0.1,           // 0-1, default 0.1
  maxOutputTokens: 2048,      // Default 2048
  responseFormat: 'json'      // 'json' o 'text'
}
Retorno
javascript{
  success: true,
  data: {
    response: {...},  // JSON parseado si responseFormat='json'
    tokensUsed: 456,
    model: 'gemini-2.5-flash'
  }
}
Ejemplo 1: OCR de Ticket
javascriptfunction analyzeTicket(imageBase64) {
  const prompt = `
    Analiza esta imagen de ticket de casino y extrae:
    - Monto (n√∫mero decimal)
    - Fecha (formato YYYY-MM-DD)
    - N√∫mero de ticket
    - Nombre de casino (si visible)
    
    Retorna JSON con estructura:
    {
      "amount": 100.50,
      "date": "2025-10-08",
      "ticketNumber": "ABC123",
      "casino": "Casino Del Mar"
    }
  `;
  
  const result = CLib.callGenerativeApi(prompt, imageBase64, {
    responseFormat: 'json'
  });
  
  if (!result.success) {
    throw new Error('Error en OCR: ' + result.error);
  }
  
  return result.data.response;
}
Ejemplo 2: Clasificaci√≥n de Texto
javascriptfunction classifyDocument(text) {
  const prompt = `
    Clasifica el siguiente documento en una de estas categor√≠as:
    - AXES_VOUCHER
    - SIELCON_TITO
    - SIELCON_BY_PLAYER
    - UNKNOWN
    
    Documento:
    ${text}
    
    Retorna solo el nombre de la categor√≠a.
  `;
  
  const result = CLib.callGenerativeApi(prompt, null, {
    responseFormat: 'text'
  });
  
  return result.data.response.trim();
}
Casos de Error
javascript{
  success: false,
  error: "API quota exceeded" // o "Invalid image format", etc.
}
L√≠mites y Cuotas

‚úÖ Google Workspace: 1000 requests/d√≠a (corporativo)
‚ö†Ô∏è Im√°genes: Max 4MB
‚ö†Ô∏è Timeout: 60 segundos


insertRowIntoBigQuery()
Inserta fila en tabla de BigQuery.
Sintaxis
javascriptCLib.insertRowIntoBigQuery(projectId, datasetId, tableId, row)
Par√°metros
NombreTipoRequeridoDescripci√≥nprojectIdStringS√≠ID del proyecto GCPdatasetIdStringS√≠ID del datasettableIdStringS√≠ID de la tablarowObjectS√≠Datos a insertar
Retorno
javascript{
  success: true,
  data: {
    inserted: true,
    rowId: "abc123xyz"
  }
}
Ejemplo de Uso
javascriptfunction saveTicketToBigQuery(ticketData) {
  const PROJECT_ID = 'grupo-angel';
  const DATASET_ID = 'casino';
  const TABLE_ID = 'tickets';
  
  // Preparar row con schema correcto
  const row = {
    ticket_id: ticketData.id,
    amount: parseFloat(ticketData.amount),
    date: ticketData.date,
    operator_email: Session.getActiveUser().getEmail(),
    status: 'pending',
    ocr_confidence: ticketData.confidence || 0.95,
    created_at: new Date().toISOString()
  };
  
  const result = CLib.insertRowIntoBigQuery(
    PROJECT_ID,
    DATASET_ID,
    TABLE_ID,
    row
  );
  
  if (!result.success) {
    CLib.logDebugMessage('Error insertando a BigQuery', {
      error: result.error,
      row: row
    });
    throw new Error('No se pudo guardar en BigQuery');
  }
  
  return result.data.rowId;
}
Schema Validation
La funci√≥n valida tipos autom√°ticamente:

‚úÖ Convierte strings a n√∫meros si el schema lo requiere
‚úÖ Valida fechas en formato ISO 8601
‚úÖ Rechaza campos no definidos en schema

Casos de Error
javascript{
  success: false,
  error: "Schema mismatch: field 'amount' expected NUMERIC, got STRING"
}
Notas

‚ö†Ô∏è Requiere que la tabla ya exista
‚ö†Ô∏è No crea datasets autom√°ticamente
‚úÖ Usa streaming insert (inmediato, no batch)


üîÑ ETL Module
Funciones para transformaci√≥n de datos de casino.

detectFileType()
Detecta el tipo de archivo/sistema de casino.
Sintaxis
javascriptCLib.detectFileType(content)
Par√°metros
NombreTipoRequeridoDescripci√≥ncontentStringS√≠Contenido del archivo (HTML o texto)
Retorno
javascript{
  success: true,
  data: {
    type: "AXES_GAMING_VOUCHER",
    confidence: 0.95,
    system: "AXES"
  }
}
Tipos Detectables

AXES_GAMING_VOUCHER
AXES_TITO_BREAKDOWN
SIELCON_TITO
SIELCON_BY_PLAYER
UNKNOWN

Ejemplo de Uso
javascriptfunction processUploadedFile(fileId) {
  const file = DriveApp.getFileById(fileId);
  const content = file.getBlob().getDataAsString();
  
  // Detectar tipo
  const typeResult = CLib.detectFileType(content);
  
  if (!typeResult.success || typeResult.data.type === 'UNKNOWN') {
    throw new Error('Tipo de archivo no soportado');
  }
  
  // Transformar seg√∫n tipo
  let transformResult;
  switch(typeResult.data.type) {
    case 'AXES_GAMING_VOUCHER':
      transformResult = CLib.transformAxesGamingVoucher(content);
      break;
    case 'SIELCON_TITO':
      transformResult = CLib.transformSielconTITO(content);
      break;
    // ... otros casos
  }
  
  return transformResult;
}
L√≥gica de Detecci√≥n
javascript// Busca patrones espec√≠ficos en HTML
if (content.includes('AXES Gaming')) return 'AXES_GAMING_VOUCHER';
if (content.includes('SIELCON') && content.includes('TITO')) return 'SIELCON_TITO';
// ... m√°s patterns

transformAxesGamingVoucher()
Transforma archivo de vouchers de AXES Gaming.
Sintaxis
javascriptCLib.transformAxesGamingVoucher(htmlContent)
Par√°metros
NombreTipoRequeridoDescripci√≥nhtmlContentStringS√≠HTML del archivo AXES
Retorno
javascript{
  success: true,
  data: {
    type: 'GAMING_VOUCHER',
    system: 'AXES',
    records: [
      {
        date: '2025-10-08',
        time: '14:30:00',
        voucherNumber: 'V123456',
        amount: 100.50,
        machineNumber: 'M001',
        status: 'PAID'
      },
      // ... m√°s records
    ],
    summary: {
      totalRecords: 150,
      totalAmount: 15000.75,
      dateRange: {
        from: '2025-10-01',
        to: '2025-10-08'
      }
    }
  }
}
Ejemplo de Uso
javascriptfunction importAxesVouchers(fileId) {
  const file = DriveApp.getFileById(fileId);
  const html = file.getBlob().getDataAsString();
  
  const result = CLib.transformAxesGamingVoucher(html);
  
  if (!result.success) {
    throw new Error('Error transformando AXES: ' + result.error);
  }
  
  // Insertar cada record a BigQuery
  const PROJECT_ID = 'grupo-angel';
  const DATASET_ID = 'casino';
  const TABLE_ID = 'vouchers';
  
  result.data.records.forEach(record => {
    CLib.insertRowIntoBigQuery(PROJECT_ID, DATASET_ID, TABLE_ID, record);
  });
  
  return result.data.summary;
}

transformAxesTITOBreakdown()
Transforma breakdown de tickets TITO de AXES.
Sintaxis
javascriptCLib.transformAxesTITOBreakdown(htmlContent)
Estructura Similar a transformAxesGamingVoucher()
Campos Espec√≠ficos
javascript{
  ticketNumber: 'T789012',
  denomination: 25.00,
  quantity: 4,
  subtotal: 100.00,
  // ...
}

transformSielconTITO()
Transforma reportes TITO de SIELCON.
Sintaxis
javascriptCLib.transformSielconTITO(htmlContent)
Retorno
javascript{
  success: true,
  data: {
    type: 'TITO_REPORT',
    system: 'SIELCON',
    records: [
      {
        date: '2025-10-08',
        ticketNumber: 'TITO-12345',
        amount: 50.00,
        machineId: 'SLT-045',
        status: 'REDEEMED'
      }
    ]
  }
}

transformSielconByPlayer()
Transforma reportes por jugador de SIELCON.
Sintaxis
javascriptCLib.transformSielconByPlayer(htmlContent)
Retorno
javascript{
  success: true,
  data: {
    type: 'PLAYER_REPORT',
    system: 'SIELCON',
    records: [
      {
        playerId: 'P12345',
        playerName: 'John Doe',
        totalBets: 1000.00,
        totalWins: 850.00,
        netResult: -150.00,
        sessionsCount: 5
      }
    ]
  }
}

üì¶ Legacy Module
‚ö†Ô∏è Funciones deprecadas - No usar en c√≥digo nuevo

xls2gsheet() ‚ö†Ô∏è DEPRECATED
Raz√≥n: L√≥gica duplicada, usar transformSielconTITO() en su lugar
Sintaxis
javascriptCLib.xls2gsheet(fileId)
Migraci√≥n
javascript// ‚ùå Viejo (deprecated)
const result = CLib.xls2gsheet(fileId);

// ‚úÖ Nuevo (usar esto)
const file = DriveApp.getFileById(fileId);
const content = file.getBlob().getDataAsString();
const type = CLib.detectFileType(content);
const result = CLib.transformSielconTITO(content);

extraerDatosDeHTML() ‚ö†Ô∏è DEPRECATED
Raz√≥n: Reemplazado por funciones ETL espec√≠ficas
Migraci√≥n
javascript// ‚ùå Viejo
const data = CLib.extraerDatosDeHTML(html);

// ‚úÖ Nuevo
const type = CLib.detectFileType(html);
const data = CLib['transform' + type](html);  // Dynamic call

üîß Mantenimiento de Esta Documentaci√≥n
Cu√°ndo Actualizar
‚úÖ Agregar Nueva Funci√≥n

Agrega c√≥digo a CLib

javascript   /**
    * Nueva funci√≥n descriptiva
    * @param {string} param1 - Descripci√≥n
    * @returns {Object} {success, data/error}
    */
   function nuevaFuncion(param1) {
     // ... c√≥digo
   }

Actualiza este documento

Agrega entrada en √≠ndice
Crea secci√≥n completa con ejemplos
Incluye casos de error


Commit

bash   git add human/reference/clib-api.md
   git commit -m "docs(clib): agregar documentaci√≥n de nuevaFuncion()"
‚úÖ Modificar Funci√≥n Existente

Actualiza JSDoc en c√≥digo
Actualiza secci√≥n en este doc
Agrega nota de cambio:

markdown   > **Actualizado en v6.1.0**: Ahora acepta par√°metro opcional `timeout`
‚úÖ Deprecar Funci√≥n

Marca en c√≥digo:

javascript   /**
    * @deprecated Usar nuevaFuncion() en su lugar
    */

Mueve a secci√≥n Legacy
Agrega gu√≠a de migraci√≥n

Template para Nueva Funci√≥n
markdown### `nombreFuncion()`

Descripci√≥n breve de qu√© hace.

#### Sintaxis
\```javascript
CLib.nombreFuncion(param1, param2)
\```

#### Par√°metros
| Nombre | Tipo | Requerido | Descripci√≥n |
|--------|------|-----------|-------------|
| `param1` | String | S√≠ | Qu√© es este par√°metro |

#### Retorno
\```javascript
{
  success: true,
  data: {
    // estructura de respuesta
  }
}
\```

#### Ejemplo de Uso
\```javascript
function ejemploUso() {
  const result = CLib.nombreFuncion('valor');
  // ... usar result
}
\```

#### Casos de Error
\```javascript
{
  success: false,
  error: "Descripci√≥n del error"
}
\```

#### Notas
- ‚úÖ Nota importante 1
- ‚ö†Ô∏è Advertencia importante
Checklist Pre-Commit
Antes de hacer commit de cambios a este doc:

 JSDoc actualizado en c√≥digo fuente
 √çndice actualizado
 Ejemplos funcionan (probados)
 Casos de error documentados
 Links internos funcionan
 Formato consistente con otras funciones


üîó Links Relacionados

üìñ System Overview
üìñ Creating New App (pr√≥ximamente)
üìñ AngelStyle API Reference (pr√≥ximamente)
üíª CLib Source Code


√öltima actualizaci√≥n: Octubre 2025
Mantenido por: Christian Luciani (@ChristianLuciani)
Versi√≥n CLib: v6.0.0
